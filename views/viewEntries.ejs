<%- include('templates/header.ejs') %>
    <div class="back-button">
        <a href="/journal">
            <img class="back-image" src="/images/back.png">
        </a>
    </div>
    <div class="entries-welcome">
        <h2
            style="font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif">
            <%= username %>'s Journal Entries
        </h2>
    </div>
    <div class="view-entries-container">
        <div class="viewEntriesRow" id="entriesContainer">
            <!-- Journal entries will be appended here dynamically -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const urlParams = new URLSearchParams(window.location.search);
            const selectedDate = urlParams.get('date');
            if (!selectedDate) {
                fetch('/getJournalEntries')
                    .then(response => response.json())
                    .then(entries => {
                        console.log(entries);

                        entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                        if (entries.length === 0) {
                            // If no entries, display a message
                            const entriesContainer = document.getElementById('entriesContainer');
                            const noEntriesMessage = document.createElement('p');
                            noEntriesMessage.textContent = 'No journal entries found.';
                            entriesContainer.appendChild(noEntriesMessage);
                        } else {
                            // Loop through each journal entry
                            entries.forEach(entry => {
                                // Display each journal entry
                                displayJournalEntry(entries, entry);
                            });
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching journal entries:', err);
                        const entriesContainer = document.getElementById('entriesContainer');
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = 'An error occurred while fetching journal entries.';
                        entriesContainer.appendChild(errorMessage);
                    });
            } else {
                fetch('/getJournalEntries')
                    .then(response => response.json())
                    .then(entries => {
                        // Filter entries based on selected date
                        const filteredEntries = entries.filter(entry => {
                            const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                            return entryDate === selectedDate;
                        });

                        filteredEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                        filteredEntries.forEach(entry => displayJournalEntry(filteredEntries, entry));
                    })
                    .catch(err => {
                        console.error('Error fetching journal entries:', err);
                        const entriesContainer = document.getElementById('entriesContainer');
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = 'An error occurred while fetching journal entries.';
                        entriesContainer.appendChild(errorMessage);
                    });
            }
        });

        function displayJournalEntry(entries, entry) {
            const entriesContainer = document.getElementById('entriesContainer');
            const cardCol = document.createElement('div');
            cardCol.className = 'col-lg-10 mx-auto p-4';

            const card = document.createElement('div');
            card.className = 'card entries-card';
            card.style.height = 'auto';

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const cardTitle = document.createElement('h5');
            cardTitle.className = 'card-title';
            const entryDate = new Date(entry.timestamp).toLocaleDateString();
            cardTitle.textContent = entryDate;

            const cardText = document.createElement('p');
            cardText.className = 'card-text';
            cardText.textContent = entry.entry;

            cardBody.appendChild(cardTitle);
            cardBody.appendChild(cardText);
            card.appendChild(cardBody);
            cardCol.appendChild(card);
            entriesContainer.appendChild(cardCol);
        }
    </script>
    <%- include('templates/footer.ejs') %>